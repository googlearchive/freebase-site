
/*
 * Copyright 2010, Google Inc.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * Additional Licenses for Third Party components can be found here:
 * http://wiki.freebase.com/wiki/Freebase_Site_License
 *
 */
(function(e,d){d.require("dojo.date.stamp");d.require("dojo.date.locale");d.require("dojo.number");e.fn.validate_input=function(b){return this.each(function(){var a=e(this);if(a.is(":text")){var c=a.data("$.validate_input");c&&c._destroy();c=new f(this,b);a.data("$.validate_input",c)}})};var f=e.validate_input=function(b,a){var c=this.options=e.extend(true,{},f.defaults,a);if(typeof c.validator!=="function")throw"A validator is required";if(!c.lang)c.lang="/lang/en";c.lang=c.lang==="/lang/en"?["lang/en"]:
[c.lang,"/lang/en"];c.locales=[];e.each(c.lang,function(h,i){c.locales[h]=d.i18n.normalizeLocale(i.split("/").pop())});this.input=e(b);this.init();var g=this;this.input.bind("remove",function(){g._destroy()});return this};f.prototype={init:function(){var b=this;this.input.bind("keyup.validate_input",function(a){b.textchange(a)}).bind(e.browser.msie?"paste.validate_input":"input.validate_input",function(a){b.textchange(a)}).bind("keypress.validate_input",function(a){a.keyCode===13&&b.validate(true)}).bind("blur.validate_input",
function(){b.validate(true)})},_destroy:function(){this.input.unbind(".validate_input")},valid:function(b){this.input.trigger("valid",b)},invalid:function(b,a){this.input.trigger("invalid",a)},empty:function(){this.input.trigger("empty")},textchange:function(){clearTimeout(this.textchange_timeout);var b=this;this.textchange_timeout=setTimeout(function(){b.validate()},200)},validate:function(b){b&&clearTimeout(this.textchange_timeout);b=this.options;var a=e.trim(this.input.val());if(a==="")return this.empty();
try{return this.valid(b.validator(a,b))}catch(c){return this.invalid(a,""+c)}}};e.extend(f,{defaults:{validator:function(b){return{text:b,value:b}}},log:function(){},invalid:function(b,a,c,g){throw new Error("Invalid "+c+(g?": "+g:""));},text:function(b,a){if(b.lengh>4096)return this.invalid(b,a,type,"Text too long");return{text:b,value:b}},topic:function(){return f.defaults.validator},enumerated:function(){return f.defaults.validator},"boolean":function(){return f.defaults.validator},uri:function(b,
a){var c=f.uri.regex;if(!c)c=f.uri.regex=/^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i;
if(c.test(b))return{text:b,value:b};return f.invalid(b,a,"uri")},"int":function(b,a){return f.number.parse(b,a,false)},"float":function(b,a){return f.number.parse(b,a,true)},number:function(b,a,c){return f.number.parse(b,a,c)},datetime:function(b,a){return f.datetime.parse(b,a)},mqlkey:function(b,a){var c=f.mqlkey.regex;if(!c)c=f.mqlkey.regex=/^[A-Za-z0-9][A-Za-z0-9_-]*$/;if(c.test(b))return{text:b,value:b};return f.invalid(b,a,"mqlkey")}});e.extend(f.number,{parse:function(b,a,c){var g=a&&a.locales||
["en"],h,i;h=0;for(i=g.length;h<i;h++){var l=g[h];a=d.number.parse(b,{locale:l});if(!isNaN(a)){b={};if(c){b.value=a;b.text=d.number.format(a,{locale:l})}else{b.value=d.number.round(a,0);b.text=d.number.format(b.value,{locale:l})}return b}}throw f.invalid("number",b);}});e.extend(f.datetime,{formats:["yyyy",["dateFormatItem-y"],"yyyy-MM",["dateFormatItem-yM","dateFormatItem-yMMM"],"yyyy-MM-dd",["dateFormat-short","dateFormat-medium","dateFormat-long"]],parse:function(b,a){if(!d.date.stamp._isoRegExp)d.date.stamp._isoRegExp=
/^(?:(-?\d{4})(?:-(\d{2})(?:-(\d{2}))?)?)?(?:T(\d{2}):(\d{2})(?::(\d{2})(.\d+)?)?((?:[+-](\d{2}):(\d{2}))|Z)?)?$/;var c=d.date.stamp.fromISOString(b);if(c)return{text:b,value:b,date:c};var g=a&&a.locales||["en"],h,i,l,j,k,n;h=0;for(i=g.length;h<i;h++){var m=g[h],o=d.date.locale._getGregorianBundle(m);l=0;for(j=f.datetime.formats.length;l<j;l+=2){var p=f.datetime.formats[l],r=f.datetime.formats[l+1];k=0;for(n=r.length;k<n;k++){var q=o[r[k]];if(q){q=i18n.normalize_pattern(q);try{c=d.date.locale.parse(b,
{datePattern:q,selector:"date",locale:m});return{text:b,value:d.date.locale.format(c,{datePattern:p,selector:"date"}),date:c}}catch(s){}}}}}throw f.invalid("datetime",b);}})})(jQuery,dojo);
(function(e){e.fn.data_input=function(d){return this.each(function(){var f=e(this),b=f.data("$.data_input");b&&b._destroy();b=new e.data_input(this,d);f.data("$.data_input",b)})};e.data_input=function(d,f){this.options=e.extend(true,{},e.data_input.defaults,f);this.container=e(d);this.metadata=this.container.metadata();this.input=e(":input",this.container);this.init();var b=this;this.input.bind("remove",function(){b._destroy()})};e.data_input.prototype={init:function(){var d=this,f=this.container,
b=this.input,a=this.options;b.bind("focusin.data_input",function(){d.container.addClass("focus")}).bind("focusout.data_input",function(){d.container.removeClass("focus")}).bind("valid.data_input",function(c,g){var h={name:d.input.attr("name")};if(g.id)h.id=g.id;else{h.value=g.value;if(d.metadata.type==="/type/text")h.lang=d.metadata.lang||a.lang}d.container.data("data",h);d.container.removeClass("error").addClass("valid");d.container.trigger("valid")}).bind("invalid.data_input",function(){d.container.removeData("data");
d.container.removeClass("valid").addClass("error");d.container.trigger("invalid")}).bind("empty.data_input",function(){var c={name:d.input.attr("name")};if(d.metadata&&d.metadata.lang)c.lang=d.metadata.lang;d.container.data("data",c);d.container.removeClass("valid").removeClass("error");d.container.trigger("empty")}).bind("keypress.data_input",function(c){c.keyCode===13&&!c.isDefaultPrevented()&&d.container.trigger("submit")}).bind("keyup.data_input",function(c){c.keyCode===27&&d.container.trigger("cancel")});
if(f.is(".topic")){b.validate_topic(e.extend(true,{},a.suggest,{type:d.metadata.type})).bind("valid.data_input",function(c,g){d.fb_select(g)}).bind("invalid.data_input",function(){d.fb_textchange()});if(this.metadata&&this.metadata.id){b.data("data.suggest",this.metadata);this.validate()}}else if(f.is(".text"))b.validate_input({validator:e.validate_input.text});else if(f.is(".datetime"))b.validate_input({validator:e.validate_input.datetime,lang:a.lang});else if(f.is(".enumerated")){b.validate_enumerated().bind("valid.data_input",
function(c,g){d.fb_select(g)}).bind("invalid.data_input",function(){d.fb_textchange()});this.metadata&&this.metadata.id&&this.validate()}else if(f.is(".int"))b.validate_input({validator:e.validate_input["int"],lang:a.lang});else if(f.is(".float"))b.validate_input({validator:e.validate_input["float"],lang:a.lang});else if(f.is(".uri"))b.validate_input({validator:e.validate_input.uri});else if(f.is(".boolean"))b.validate_boolean();else if(f.is(".enumeration"))b.validate_input({validator:e.validate_input.mqlkey});
else if(f.is(".rawstring"))b.validate_input({validator:e.validate_input.text});else throw new Error("Invalid data-input: "+f.attr("class"));},_destroy:function(){this.input.unbind(".data_input")},validate:function(){var d=this.input;e.each(["$.validate_topic","$.validate_input","$.validate_enumerated","$.validate_boolean"],function(f,b){var a=d.data(b);if(a){a.validate(true);return false}})},reset:function(){this.container.removeData("data");if(this.input.is(":text"))this.input.val("");else if(this.input.is("select"))this.input[0].selectedIndex=
0;else this.input.is(":radio")&&this.input.each(function(){this.checked=false})},fb_textchange:function(){},fb_select:function(){},ajax_beforeSend:function(d){if(!this.xhr_queue)this.xhr_queue=[];this.xhr_queue.push(d);this.container.trigger("loading")},ajax_complete:function(d){if(!this.xhr_queue)this.xhr_queue=[];for(var f=0,b=this.xhr_queue.length;f<b;f++)if(d===this.xhr_queue[f]){this.xhr_queue.splice(f,1);break}this.xhr_queue.length===0&&this.container.trigger("loading_complete")}};e.extend(e.data_input,
{defaults:{suggest:{service_url:"http://www.freebase.com",service_path:"/private/suggest",flyout_service_url:"http://www.freebase.com",flyout_service_path:"/private/flyout",mqlread_url:"http://api.freebase.com/api/service/mqlread",category:"object",type:"/common/topic"}}});e.fn.validate_topic=function(d){return this.each(function(){var f=e(this);if(f.is(":text")){var b=f.data("$.validate_topic");b&&b._destroy();b=new e.validate_topic(this,d);f.data("$.validate_topic",b)}})};e.validate_topic=function(d,
f){this.options=e.extend(true,{},f);this.input=e(d);this.init()};e.validate_topic.prototype={init:function(){var d=this;this.input.suggest(this.options).bind("fb-textchange.validate_topic",function(){d.input.val()===""?d.empty():d.invalid()}).bind("fb-select.validate_topic",function(f,b){d.input.val(b.name!=null?b.name:b.id);d.valid(b)})},invalid:function(){this.input.trigger("invalid")},valid:function(d){this.input.trigger("valid",d)},empty:function(){this.input.trigger("empty")},_destroy:function(){this.input.unbind(".validate_topic")},
validate:function(){if(this.input.val()==="")this.empty();else{var d=this.input.data("data.suggest");d?this.valid(d):this.invalid()}}};e.fn.validate_enumerated=function(d){return this.each(function(){var f=e(this);if(f.is("select")){var b=f.data("$.validate_enumerated");b&&b._destroy();b=new e.validate_enumerated(this,d);f.data("$.validate_enumerated",b)}})};e.validate_enumerated=function(d,f){this.options=e.extend(true,{},f);this.input=e(d);this.init()};e.validate_enumerated.prototype={init:function(){var d=
this;this.input.bind("change.validate_enumerated, keypress.validate_enumerated",function(){this.selectedIndex===0?d.empty():d.valid({text:e(":selected",this).text(),id:this.value})})},invalid:function(){this.input.trigger("invalid")},valid:function(d){this.input.trigger("valid",d);this.input.trigger("fb-select",d)},empty:function(){this.input.trigger("empty")},_destroy:function(){this.input.unbind(".validate_enumerated")},validate:function(){var d=this.input[0];d.selectedIndex>0?this.valid({text:e(":selected",
this.input).text(),id:d.value}):this.empty()}};e.fn.validate_boolean=function(d){var f,b;this.each(function(){var c=e(this);if(c.is(":radio"))if(c.val().toLowerCase()==="true")f=c;else if(c.val().toLowerCase()==="false")b=c});if(f&&b){var a=f.data("$.validate_boolean");a&&a._destroy();a=new e.validate_boolean(f,b,d);f.data("$.validate_boolean",a)}return this};e.validate_boolean=function(d,f,b){this.options=e.extend(true,{},b);this.tradio=d;this.fradio=f;this.input=this.tradio;this.init()};e.validate_boolean.prototype=
{init:function(){var d=this;this.tradio.bind("change.validate_boolean",function(){d.validate()})},_destroy:function(){this.input.unbind(".validate_boolean")},valid:function(d){this.input.trigger("valid",d)},empty:function(){this.input.trigger("empty")},validate:function(){if(this.tradio.is(":checked"))this.valid({text:this.tradio.text(),value:true});else this.fradio.is(":checked")?this.valid({text:this.fradio.text(),value:false}):this.empty()}}})(jQuery);
(function(e){var d=window.editparams={Empty:function(f,b,a){this.structure=f;this.data=b;this.msg=a;this.toString=function(){return"Empty: "+this.msg}},Invalid:function(f,b,a){this.structure=f;this.data=b;this.msg=a;this.toString=function(){return"Invalid: "+this.msg}},parse:function(f,b){function a(l,j,k,n,m){try{d.validate(j,k);m.push(k)}catch(o){if(o instanceof d.Empty)m.push(k);else throw o;}}var c=(f.values||[]).slice(),g=f.properties||[],h=f.expected_type.mediator||g.length;if(h){if(!g.length)throw new d.Invalid(f,
null,"mediator musth have 1 or more properties");if(c.length&&c.length!==1)throw new d.Invalid(f,null,"Can't edit more than one value (row) for a mediator");}var i=[];e(".data-input",b).each(function(){var l=e(this),j=l.data("$.data_input");if(!j)throw new d.Invalid(f,null,"$.data-input not initialized for",this);j.validate(true);if(l.is(".error"))throw new d.Invalid(f,null,"$.data-input is invalid",this);j=l.data("data");if(!j)throw new d.Invalid(f,null,"$.data-input has no data",this);if(h){if(!i.length){i.push({});
e.each(g,function(m,o){i[0][o.id]=e.extend({},o,{values:[]})})}var k=i[0][j.name];if(k){var n=[];if(c.length)n=c[0][k.id].values||[];a(l,k,j,n,k.values)}else console.warn("editparams","unknown mediator property data",j)}else a(l,f,j,c,i)});return h?d.parse_mediator(f,c,i):d.parse_simple(f,c,i)},parse_mediator:function(f,b,a){if(a.length!==1)throw new d.Invalid(f,a,"Must specify one (new or updated) value for a mediator");a=a[0];var c;if(b.length)c=b[0];b={};if(c)b.id=c.id;else{b.id=null;b.create=
"unconditional";b.connect=f.unique?"replace":"insert";var g=[];f.expected_type.id!=="/type/object"&&g.push({id:f.expected_type.id,connect:"insert"});var h=f.expected_type.included_types;h&&h.forEach(function(n){n!=="/type/object"&&g.push({id:n,connect:"insert"})});if(g.length)b.type=g}h=false;f=f.properties;for(var i=0,l=f.length;i<l;i++){var j=f[i],k=d.parse_simple(j,c&&c[j.id]&&c[j.id].values||[],a[j.id]&&a[j.id].values||[]);if(k.length){b[j.id]=k;h=true}}return h?[b]:[]},parse_simple:function(f,
b,a){return d.diff(f,b,a)},diff:function(f,b,a){var c=f.expected_type,g=f.expected_type.id,h=f.unique,i=g==="/type/text";if(h)if(!i)if(b.length&&b.length!==1)throw new d.Invalid(f,b,"Can't edit more than one value (row) for a unique property.");else if(a.length&&a.length!==1)throw new d.Invalid(f,a,"Can't edit more than one value (row) for a unique property.");var l=[];if(d.LITERAL_TYPE_IDS[g]){l.push("value");i&&l.push("lang")}else l.push("id");g=[];var j=[],k,n;k=0;for(n=b.length;k<n;k++){var m=
b[k];d.validate(f,m);d.inArray.apply(null,[m,a].concat(l))===-1&&g.push(d.clause(m,"delete"))}k=0;for(n=a.length;k<n;k++){m=a[k];try{d.validate(f,m)}catch(o){continue}if(d.inArray.apply(null,[m,b].concat(l))===-1){if(h)if(i){var p=d.inArray(m,g,"lang");p!==-1&&g.splice(p,1)}else return[d.clause(m,"replace",c)];j.push(d.clause(m,h?"replace":"insert",c))}}return g.concat(j)},validate:function(f,b){var a=f.expected_type.id;if(d.LITERAL_TYPE_IDS[a])if(d.isEmpty(b.value))throw new d.Empty(f,b);else{if(a===
"/type/text"&&d.isEmpty(b.lang))throw new d.Invalid(f,b,"Expected data.lang for /type/text");if(a==="/type/int"||a==="/type/float"){if(e.type(b.value)!=="number")throw new d.Invalid(f,b,"Expected number data.value for "+a);}else if(a==="/type/boolean"){if(e.type(b.value)!=="boolean")throw new d.Invalid(f,b,"Expected boolean data.value for /type/boolean");}else if(e.type(b.value)!=="string")throw new d.Invalid(f,b,"Expected string data.value for "+a);}else if(d.isEmpty(b.id))throw new d.Empty(f,b);
return b},clause:function(f,b,a){var c={connect:b};if(f.id){c.id=f.id;if(b!=="delete"&&a&&!a.enumeration){var g=[];a.id!=="/type/object"&&g.push({id:a.id,connect:"insert"});(f=a.included_types)&&f.forEach(function(h){h!=="/type/object"&&g.push({id:h,connect:"insert"})});if(g.length)c.type=g}}else{c.value=f.value;if(f.lang)c.lang=f.lang}return c},inArray:function(f,b){var a=Array.prototype.slice.call(arguments,2);if(!a.length)return e.inArray(f,b);for(var c=0,g=b.length;c<g;c++){for(var h=b[c],i=true,
l=0,j=a.length;l<j;l++){var k=a[l];if(h[k]!=f[k]){i=false;break}}if(i)return c}return-1},isEmpty:function(f){return f==null||f===""},LITERAL_TYPE_IDS:{"/type/int":1,"/type/float":1,"/type/boolean":1,"/type/rawstring":1,"/type/uri":1,"/type/text":1,"/type/datetime":1,"/type/id":1,"/type/key":1,"/type/value":1,"/type/enumeration":1}}})(jQuery);
(function(e,d,f){var b=d.edit={prop_add_begin:function(a,c){var g={s:d.options.id,p:a.attr("data-id"),lang:d.options.lang};e.ajax({url:d.options.base_ajax_url+"/prop_add_begin.ajax",data:g,dataType:"json",success:function(h,i,l){if(h.code!=="/api/status/ok")return b.ajax_error(l,null,a);h=e(h.result.html).hide();var j={mode:"add",event_prefix:"propbox.edit.prop_add.",ajax:{data:g,url:d.options.base_ajax_url+"/prop_edit_submit.ajax"},init:b.init_prop_add_form,submit:b.submit_prop_add_form,prop_section:a,
msg_row:e(".row-msg",h),edit_row:e(".edit-row",h),submit_row:e(".edit-row-submit",h),structure:h.metadata()};b.init(j);j.edit_row.bind("propbox.edit.prop_add.success",function(){if(c)j.edit_row.trigger(j.event_prefix+"cancel");else{b.reset_data_inputs(j);e(":input:visible:first",j.edit_row).focus();e(".button-submit",j.submit_row).attr("disabled","disabled").addClass("disabled");e(".button-cancel",j.submit_row).text("Done")}})},error:function(h){b.ajax_error(h,null,a)}})},init_prop_add_form:function(a){b.init_data_inputs(a);
e(":input:visible:first",a.edit_row).focus()},submit_prop_add_form:function(a){var c=e.extend({},a.ajax.data);try{var g=f.parse(a.structure,a.edit_row);c.o=JSON.stringify(g)}catch(h){c=e(".data-input.error",a.edit_row);if(c.length){a.edit_row.trigger(a.event_prefix+"error","Please specify a valid value");c.eq(0).find(":input").focus().select()}else a.edit_row.trigger(a.event_prefix+"error",h.toString());return}e.ajax({url:a.ajax.url,type:"POST",dataType:"json",data:c,success:function(i,l,j){if(i.code!==
"/api/status/ok")return b.ajax_error(j,a);i=e(i.result.html);a.msg_row.before(i);i18n.ize(i);e(".edit",i).show();d.init_menus(i,true);d.kbs.set_next(null,i,true);a.edit_row.trigger(a.event_prefix+"success")},error:function(i){b.ajax_error(i,a)}})},value_edit_begin:function(a,c){var g;if(c.is("tr"))g=c.attr("data-id");else{g=e(".property-value:first",c);g=g.attr("data-id")||g.attr("data-value")||g.attr("datetime")}var h={s:d.options.id,p:a.attr("data-id"),replace:g,lang:d.options.lang};e.ajax({url:d.options.base_ajax_url+
"/value_edit_begin.ajax",data:h,dataType:"json",success:function(i,l,j){if(i.code!=="/api/status/ok")return b.ajax_error(j,null,a,c);i=e(i.result.html).hide();var k={mode:"edit",event_prefix:"propbox.edit.value_edit.",ajax:{data:h,url:d.options.base_ajax_url+"/prop_edit_submit.ajax"},init:b.init_value_edit_form,submit:b.submit_value_edit_form,prop_section:a,prop_row:c,msg_row:e(".row-msg",i),edit_row:e(".edit-row",i),submit_row:e(".edit-row-submit",i),structure:i.metadata()};b.init(k);k.edit_row.bind("propbox.edit.value_edit.success",
function(){k.msg_row.remove();k.edit_row.remove();k.submit_row.remove()}).bind("propbox.edit.value_edit.cancel",function(){k.prop_row.show()}).bind("propbox.edit.value_edit.delete",function(){b.loading_begin(k);d.edit.value_delete_begin(a,c,function(){k.msg_row.remove();k.edit_row.remove();k.submit_row.remove()})})},error:function(i){b.ajax_error(i,null,a,c)}})},init_value_edit_form:function(a){b.init_data_inputs(a);e(":input:visible:first",a.edit_row).focus()},submit_value_edit_form:function(a){var c=
e.extend({},a.ajax.data);try{var g=f.parse(a.structure,a.edit_row);c.o=JSON.stringify(g)}catch(h){c=e(".data-input.error",a.edit_row);if(c.length){a.edit_row.trigger(a.event_prefix+"error","Please specify a valid value");c.eq(0).find(":input").focus().select()}else a.edit_row.trigger(a.event_prefix+"error",h.toString());return}e.ajax({url:a.ajax.url,type:"POST",dataType:"json",data:c,success:function(i,l,j){if(i.code!=="/api/status/ok")return b.ajax_error(j,a);i=e(i.result.html);a.prop_row.after(i);
i18n.ize(i);e(".edit",i).show();d.init_menus(i,true);d.kbs.set_next(null,i,true);a.prop_row.remove();a.edit_row.trigger(a.event_prefix+"success")},error:function(i){b.ajax_error(i,a)}})},value_delete_begin:function(a,c,g){var h;if(c.is("tr"))h=c.attr("data-id");else{h=e(".property-value:first",c);h=h.attr("data-id")||h.attr("data-value")||h.attr("datetime")}h={s:d.options.id,p:a.attr("data-id"),o:h,lang:d.options.lang};e.ajax({url:d.options.base_ajax_url+"/value_delete_submit.ajax",type:"POST",data:h,
dataType:"json",success:function(i,l,j){if(i.code!=="/api/status/ok")return b.ajax_error(j,null,a,c);i=e(i.result.html);c.before(i);c.hide();a.removeClass("editing");g&&g()},error:function(i){b.ajax_error(i,null,a,c)}})},value_delete_undo:function(a){var c=e(a).parents(".row-msg:first"),g=c.next(".data-row:hidden"),h=g.parents(".property-section");if(g.is("tr"))a=g.attr("data-id");else{a=e(".property-value:first",g);a=a.attr("data-id")||a.attr("data-value")||a.attr("datetime")}a={s:d.options.id,p:h.attr("data-id"),
o:a,lang:d.options.lang};e.ajax({url:d.options.base_ajax_url+"/value_delete_undo.ajax",type:"POST",data:a,dataType:"json",success:function(i,l,j){if(i.code!=="/api/status/ok")return b.ajax_error(j,null,h,g);g.show();c.remove()},error:function(i){b.ajax_error(i,null,h,g)}});return false},loading_begin:function(a){e.each([a.edit_row,a.msg_row,a.submit_row],function(c,g){g&&g.addClass("loading")})},loading_complete:function(a){e.each([a.edit_row,a.msg_row,a.submit_row],function(c,g){g&&g.removeClass("loading")})},
init_data_inputs:function(a){e(".data-input",a.edit_row).each(function(){b.init_data_input(e(this),a)})},init_data_input:function(a,c){a.data_input({lang:d.options.lang,suggest:d.options.suggest}).bind("valid",function(){c.edit_row.trigger(c.event_prefix+"valid");var g=a.parent(".form-field"),h=g.next(".magicbox-template");if(h.length){h=e("<div>").html(h.html());h=e(".form-field",h);g.after(h);b.init_data_input(e(".data-input",h),c)}}).bind("empty",function(){c.edit_row.trigger(c.event_prefix+"valid")}).bind("invalid",
function(){c.edit_row.trigger(c.event_prefix+"invalid")}).bind("submit",function(){c.edit_row.trigger(c.event_prefix+"submit")}).bind("cancel",function(){c.edit_row.trigger(c.event_prefix+"cancel")}).bind("loading",function(){e(this).addClass("loading")}).bind("loading_complete",function(){e(this).removeClass("loading")});if(a.is(".datetime"))i18n.ize_datetime_input(e(":text",a));else if(a.is(".int")||a.is(".float"))i18n.ize_number_input(e(":text",a))},reset_data_inputs:function(a){e(".data-input",
a.edit_row).each(function(){e(this).data("$.data_input").reset()})},init:function(a){if(a.mode==="add"){var c=e(">.data-section",a.prop_section);e("> .data-table > tbody > .empty-row, > .data-list > .empty-row",c).hide();e("> .data-table > tbody, > .data-list",c).append(a.msg_row).append(a.edit_row).append(a.submit_row)}else if(a.mode==="edit"){a.prop_row.hide();a.prop_row.after(a.msg_row);a.msg_row.after(a.edit_row);a.edit_row.after(a.submit_row)}e(".data-table > thead",a.prop_section).show();var g=
a.event_prefix||"propbox.edit.";a.edit_row.bind(g+"valid",function(){e(".button-submit",a.submit_row).removeAttr("disabled").removeClass("disabled")}).bind(g+"invalid",function(){e(".button-submit",a.submit_row).attr("disabled","disabled").addClass("disabled")}).bind(g+"submit",function(){b.submit(a)}).bind(g+"cancel",function(){b.cancel(a)}).bind(g+"error",function(h,i){b.error(a,i);b.loading_complete(a);a.prop_section.removeClass("editing")}).bind(g+"success",function(){b.loading_complete(a);a.prop_section.removeClass("editing")});
e(".button-submit",a.submit_row).click(function(){a.edit_row.trigger(g+"submit")});e(".button-cancel",a.submit_row).click(function(){a.edit_row.trigger(g+"cancel")});e(".button-delete",a.submit_row).click(function(){a.edit_row.trigger(g+"delete")});a.edit_row.show();a.submit_row.show();d.kbs.scroll_to(a.prop_section);a.init&&a.init(a)},cancel:function(a){a.msg_row.remove();a.edit_row.remove();a.submit_row.remove();a.prop_section.removeClass("editing");a=e(">.data-section",a.prop_section);e("> .data-table > tbody > tr, > .data-list > li",
a).filter(":not(.empty-row)").length||e("> .data-table > tbody > .empty-row, > .data-list > .empty-row",a).show()},submit:function(a){if(!a.edit_row.is(".loading"))if(!e(".button-submit",a.submit_row).is(":disabled")){document.activeElement&&e(document.activeElement).blur();b.clear_form_message(a);b.loading_begin(a);a.submit&&a.submit(a)}},error:function(a,c){e(".button-submit",a.submit_row).attr("disabled","disabled").addClass("disabled");return b.form_message(a,c,"error")},form_message:function(a,
c,g){a.msg_row.find(".close-msg").css("visibility","visible").next().find(".msg-default").hide().next().text(c);a.msg_row.attr("class","row-msg");g&&a.msg_row.addClass("row-msg-"+g)},clear_form_message:function(a){a.msg_row.find(".close-msg").css("visibility","hidden").next().find(".msg-default").show().next().html("&nbsp;")},ajax_error:function(a,c,g,h){a=a.responseText;if(c)c.edit_row.trigger(c.event_prefix+"error",a);else{c=e(".data-table",g);a=c.length?b.row_msg(a,"error","tr",e(">thead>tr:first>th",
c).length):b.row_msg(a,"error","li");if(h){h.before(a);h.is(".edit-row")?h.removeClass("loading"):g.removeClass("editing")}else{c.length?e(">tbody",c).append(a):e(".data-list",g).append(a);g.removeClass("editing")}}},row_msg:function(a,c,g,h){var i=e('<a class="close-msg" href="#">x</a>').click(function(){e(this).parents(".row-msg:first").remove();return false}),l=e("<span>").text(a);a=e("<"+g+' class="row-msg">');if(g==="tr"){g=e("<td>").append(i).append(l);h&&g.attr("colspan",h);a.append(g)}else a.append(i).append(l);
c&&a.addClass("row-msg-"+c);return a}}})(jQuery,window.propbox,window.editparams);
