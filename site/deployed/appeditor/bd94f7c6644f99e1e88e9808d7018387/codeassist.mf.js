function CodeAssist(a,e,b){this._container=a;this._editor=e;this._options=b;this._assistKeyComboDetected=false;this._autoAssistTimerID=null;var d=this;try{$(e.win.document).keyup(function(f){return d._onEditorKeyUp(f)}).keydown(function(f){return d._onEditorKeyDown(f)}).keypress(function(f){return d._onEditorKeyPress(f)}).mousedown(function(f){return d._onEditorMouseDown(f)})}catch(c){alert("Unable to install keyup handler on codemirror window")}}CodeAssist.helperUrl="http://acreassist.freebaseapps.com/";
CodeAssist.prototype.dispose=function(){this._cancelPopup();this._cancelAutoAssist()};CodeAssist.prototype.getSetting=function(a){switch(a){case "dotTrigger":return this._options.dotTrigger}return null};CodeAssist.prototype.putSetting=function(a,e){switch(a){case "dotTrigger":this._options.dotTrigger=e;break}};CodeAssist.prototype._onEditorMouseDown=function(){};
CodeAssist.prototype._onEditorKeyDown=function(a){if(a.keyCode==32&&(a.ctrlKey||a.metaKey||a.altKey)){this._assistKeyComboDetected=true;a.preventDefault();return false}else a.keyCode==8&&this._cancelPopup()};CodeAssist.prototype._onEditorKeyUp=function(a){if(this._assistKeyComboDetected){this._assistKeyComboDetected=false;this.startAssistAtCursor("");a.preventDefault();return false}};
CodeAssist.prototype._onEditorKeyPress=function(a){if(!(!a.shiftKey&&a.keyCode==32||a.charCode==32)){this._cancelAutoAssist();if(!(a.ctrlKey||a.metaKey||a.altKey))if(this._options.dotTrigger&&(!a.shiftKey&&a.keyCode==46||a.charCode==46))this._scheduleAutoAssist(".");else if(!a.shiftKey&&a.keyCode==188||a.charCode==44)this._scheduleAutoAssist(",");else if(a.shiftKey&&a.keyCode==57||a.charCode==40)this._scheduleAutoAssist("(");else if(a.shiftKey&&a.keyCode==48||a.charCode==41)this._cancelPopup();else if(a.keyCode==
38||a.keyCode==40||a.keyCode==33||a.keyCode==34||a.keyCode==35||a.keyCode==36)this._cancelPopup()}};CodeAssist.prototype._cancelAutoAssist=function(){if(this._autoAssistTimerID!=null){window.clearTimeout(this._autoAssistTimerID);this._autoAssistTimerID=null}};CodeAssist.prototype._scheduleAutoAssist=function(a){var e=this;this._autoAssistTimerID=window.setTimeout(function(){e._autoAssistTimerID=null;e.startAssistAtCursor(a)},a=="."?1E3:200)};
CodeAssist.prototype._findCurrentNode=function(a,e,b){e=this._editor.win.document.body.firstChild;a=a.line||e;e=a.nextSibling;for(b=b;b>0&&e!=null&&(e.nodeType!=1||e.tagName.toLowerCase()!="br")&&e.firstChild!=null&&e.firstChild.nodeValue.length<b;){b-=e.firstChild.nodeValue.length;a=e;e=e.nextSibling}var d,c,f;if(e==null||e.tagName.toLowerCase()=="br"){if(e!=null){c=$(e).offset();if($.browser.msie&&a!=null&&a.tagName.toLowerCase()!="br"){d=a.offsetWidth;f=a.offsetHeight}else{d=c.left;f=e.offsetHeight}}else{c=
$(a).offset();d=a.firstChild?a.firstChild.nodeValue.length:0;d=c.left+(d==0?0:b*a.offsetWidth/d);f=a.offsetHeight}c=c.top}else{c=$(e).offset();d=e.firstChild?e.firstChild.nodeValue.length:0;d=c.left+(d==0?0:b*e.offsetWidth/d);c=c.top;f=e.offsetHeight}return e!=null?{left:d,top:c,height:f,currentNode:e,currentNodeOffset:b}:{left:d,top:c,height:f,currentNode:a,currentNodeOffset:a!=null&&a.firstChild!=null?a.firstChild.nodeValue.length:0}};
CodeAssist.prototype.startAssistAtCursor=function(a){this._cancelPopup();this._cancelAutoAssist();var e=this._editor.cursorPosition(false),b=this._editor.lineNumber(e.line)-1,d=e.character,c=this._editor.lineContent(e.line);e=this._findCurrentNode(e,b,d,c);c=e.currentNode;var f=e.currentNodeOffset;if(f!=null){if(c.className.indexOf("xml-")==0){var g=false;if(c.className=="xml-attribute"){var h="";for(g=c.previousSibling;g!=null&&g.className!="xml-tagname"&&g.className!="xml-tagname-acre";){if(g.className==
"xml-attname")h=g.firstChild.nodeValue;g=g.previousSibling}c=c.firstChild.nodeValue.replace(/^["']/,"").replace(/["']$/,"");f=f-1;g=h.indexOf("acre:")<0&&(g==null||g.className!="xml-tagname-acre")}else if(c.className=="xml-text"){c=c.firstChild.nodeValue;f=f;g=true}else return;h=0;if(g){h=c.substr(0,f);var m=h.lastIndexOf("{");g=h.lastIndexOf("}");if(m>0&&h.charAt(m-1)=="$"&&g<m)h=m+1;else{h=h.lastIndexOf("$");if(h>=0&&g<h)h=h+1;else return}}c=c.substr(h);f-=h}else if(c.tagName.toLowerCase()=="br"||
c.className=="whitespace"||c.className.indexOf("js-")==0&&c.className!="js-comment"){if((c.tagName.toLowerCase()=="br"||c.className=="whitespace")&&this._options.isMjt){for(g=c.previousSibling;g!=null&&g.className.indexOf("xml-")<0&&g.className.indexOf("js-")!=0;)g=g.previousSibling;if(g==null)return;else if(g.className=="xml-punctuation"&&g.firstChild.nodeValue==">"){g=g.previousSibling;if(g==null||g.className!="xml-tagname-acre"||g.firstChild.nodeValue!="acre:script")return}else if(g.className.indexOf("xml-")==
0)return}h=[];for(g=c.previousSibling;g!=null&&g.className.indexOf("xml-")<0;){g.tagName.toLowerCase()=="br"?h.unshift("\n"):h.unshift(g.firstChild.nodeValue);g=g.previousSibling}h=h.join("");c=h+(c.firstChild!=null?c.firstChild.nodeValue.substr(0,f):"");f=h.length+f}else return;a=="("||a==","?this._internalStartFunctionArgumentAssist({left:e.left,top:e.top,height:e.height},b,d,c,f):this._internalStartApiAssist({left:e.left,top:e.top,height:e.height},b,d,c,f)}};
CodeAssist.prototype._cancelPopup=function(){if("_popup"in this&&this._popup!=null){this._popup.cancel();this._popup=null}};
CodeAssist.prototype._internalStartApiAssist=function(a,e,b,d,c){d=new CodeAssist.QueryTokenizer(d,0,c);c=[];for(var f;(f=d.token())!=null;){c.push(f);d.next()}if(!(c.length>0&&c[c.length-1].type==CodeAssist.Token.Types.numberLiteral)){d=[];for(var g=c.length-1;g>=0;g--){f=c[g];if(f.type==CodeAssist.Token.Types.identifier)d.unshift(f.content);else if(f.type==CodeAssist.Token.Types.operator&&f.content==".")d.unshift(".");else if(f.type==CodeAssist.Token.Types.error)if(d.length==0)return;else break;
else if(f.type!=CodeAssist.Token.Types.whitespace)break}for(d=d.join("");;){c=d.replace(/\.\./g,".");if(d!=c)d=c;else break}var h=this,m=$(this._container).offset();m.left-=this._editor.win.document.body.scrollLeft+document.body.scrollLeft;m.top-=this._editor.win.document.body.scrollTop+document.body.scrollTop;c=d.lastIndexOf(".");if(c>=0){var p=d.substr(c+1);d=d.substr(0,c)}else{p=d;d=""}var o=function(j,i,k,l){try{var n=h._editor.nthLine(e+1),q=b-p.length;h._editor.selectLines(n,q,n,b);h._editor.editor.replaceSelection(j)}catch(u){}k=
k||j.length;l=l||j.length;window.setTimeout(function(){h._editor.selectLines(n,q+k,n,q+l);h._editor.editor.highlightAtCursor();h._editor.focus();i&&i(q+l)},100)},r=function(j){h._cancelPopup();if(typeof j=="string")o(j);else if(j.type=="module")o(j.label+".",function(){h.startAssistAtCursor()});else if(j.type=="hash")o(j.label+"[");else if(j.type=="function")("paramInfo"in j?j.paramInfo.length:j.params.length)>0?o(j.label+"(",function(){var i=h._editor.cursorPosition(false),k=h._editor.lineNumber(i.line)-
1,l=i.character,n=h._editor.lineContent(i.line);i=h._findCurrentNode(i,k,l,n);h._showFunctionArgumentAssistance(j,0,i)}):o(j.label+"()");else o(j.label)},s=function(j,i){if(b>0&&j.keyCode==8&&i.length==0){h._cancelPopup();h._editor.focus();var k=h._editor.nthLine(e+1);h._editor.selectLines(k,b-1,k,b);h._editor.editor.replaceSelection("")}else if(j.keyCode==190||j.charCode==46)o(i+".",function(){h.startAssistAtCursor()});else if(j.keyCode==57||j.charCode==40)o(i+"(",function(){h._scheduleAutoAssist("(")});
else return;j.returnValue=false;j.cancelBubble=true;"preventDefault"in j&&j.preventDefault();return false},t=function(){h._popup=new CueCard.Popup(Math.round(m.left+a.left),Math.round(m.top+a.top),Math.round(a.height),[window,h._editor.win],{onCancel:function(j){j=="key"&&h._editor.focus()}});h._popup.elmt.html("<div></div>")};if(d.length==0){t();new CueCard.SuggestionController(h._popup,h._popup.elmt[0].firstChild,new CodeAssist.SearchSuggestor(this._getLocalVariables(),r,s),p)}else{d=CodeAssist.helperUrl+
"assist?segments="+encodeURIComponent(d);CueCard.JsonpQueue.call(d,function(j){if(j.length>0){t();new CueCard.SuggestionController(h._popup,h._popup.elmt[0].firstChild,new CodeAssist.ScopedSuggestor(j,r,s),p)}},function(){})}}};
CodeAssist.prototype._getLocalVariables=function(){for(var a=[],e=function(m){return m.replace(/^\s+/,"").replace(/\s+$/,"")},b=this._editor.win.document.getElementsByTagName("span"),d=0;d<b.length;d++){var c=b[d];if(c.className=="js-variable"){for(var f=c.previousSibling,g=false,h=false;f!=null;){if(f.className=="js-keyword"){f=e(f.firstChild.nodeValue);if(f=="var")g=true;else if(f=="function")h=g=true;break}else if(f.className!="whitespace")break;f=f.previousSibling}if(g){c=e(c.firstChild.nodeValue);
a.push({label:c,type:"var",description:h?"local function":"local variable"})}}else if(c.className=="js-variabledef"){c=e(c.firstChild.nodeValue);a.push({label:c,type:"var",description:"local variable or function argument"})}}return a};
CodeAssist.prototype._internalStartFunctionArgumentAssist=function(a,e,b,d,c){d=new CodeAssist.QueryTokenizer(d,0,c);for(e=[];(b=d.token())!=null&&e.length<1E3;){e.push(b);d.next()}if(e.length!=0){var f=c=0;for(d=e.length-1;d>=0;d--){b=e[d];if(b.type==CodeAssist.Token.Types.delimiter)if(b.content=="("||b.content=="["||b.content=="{")if(c==0){d--;break}else c--;else if(b.content==")"||b.content=="]"||b.content=="}")c++;else b.content==","&&c==0&&f++}if(!(b==null||c>0)){for(c=[];d>=0;d--){b=e[d];if(b.type==
CodeAssist.Token.Types.identifier)c.unshift(b.content);else if(b.type==CodeAssist.Token.Types.operator&&b.content==".")c.unshift(".");else if(b.type!=CodeAssist.Token.Types.whitespace)break}for(c=c.join("");;){e=c.replace(/\.\./g,".");if(c!=e)c=e;else break}if(c.length!=0){var g=this;e=CodeAssist.helperUrl+"assist_args?segments="+encodeURIComponent(c);CueCard.JsonpQueue.call(e,function(h){if(h){var m=$(g._container).offset();m.left-=g._editor.win.document.body.scrollLeft+document.body.scrollLeft;
m.top-=g._editor.win.document.body.scrollTop+document.body.scrollTop;g._popup=new CueCard.Popup(Math.round(m.left+a.left),Math.round(m.top+a.top),Math.round(a.height),[window,g._editor.win],{});g._showFunctionArgumentAssistance(h,f,a)}},function(){})}}}};
CodeAssist.prototype._showFunctionArgumentAssistance=function(a,e,b){var d=this,c=$(this._container).offset();c.left-=this._editor.win.document.body.scrollLeft+document.body.scrollLeft;c.top-=this._editor.win.document.body.scrollTop+document.body.scrollTop;if(this._popup==null)this._popup=new CueCard.Popup(Math.round(c.left+b.left),Math.round(c.top+b.top),Math.round(b.height),[window,this._editor.win],{onCancel:function(p){p=="key"&&d._editor.focus()}});else this._popup.elmt.empty();b=$('<div class="codeAssist-argumentAssist-singleLine"></div>').appendTo(this._popup.elmt);
if("paramInfo"in a)for(c=0;c<a.paramInfo.length;c++){var f=a.paramInfo[c];c>0&&$("<span>, </span>").appendTo(b);if(c==e){$("<b>"+f.name+"</b>").appendTo(b);var g=$('<div class="codeAssist-argumentAssist-details"><span class="codeAssist-argumentAssist-type">'+f.type+'</span>, <span class="codeAssist-argumentAssist-optional">'+(f.optional?"optional":"required")+'</span>: <span class="codeAssist-argumentAssist-description">'+f.description+"</span></div>").appendTo(this._popup.elmt);if("structure"in f){g=
$('<div class="codeAssist-argumentAssist-structure">Keys:</div>').appendTo(g);g=$("<ul></ul>").appendTo(g);for(var h=0;h<f.structure.length;h++){var m=f.structure[h];$("<li>"+m.name+" ("+m.type+"): "+m.description+"</li>").appendTo(g)}}}else $("<span>"+f.name+"</span>").appendTo(b)}else for(c=0;c<a.params.length;c++){c>0&&$("<span>, </span>").appendTo(b);c==e?$("<b>"+a.params[c]+"</b>").appendTo(b):$("<span>"+a.params[c]+"</span>").appendTo(b)}this._popup.reposition()};
CodeAssist.renderApiSuggestion=function(a,e){if("type"in a&&a.type=="function")if("paramInfo"in a){var b=[];$.each(a.paramInfo,function(){b.push(this.name)});a.hint="("+b.join(", ")+"): "+a.description}else a.hint="("+a.params.join(", ")+"): "+a.description;else if("description"in a)a.hint=a.description;var d=a.label;if(e.length>0){var c=d.toLowerCase().indexOf(e);d=d.substr(0,c)+"<b>"+d.substr(c,e.length)+"</b>"+d.substr(c+e.length)}c="cuecard-suggestion-entry codeAssist-entry";var f="";if("deprecated"in
a&&a.deprecated){c+=" codeAssist-deprecated";f='<div class="codeAssist-deprecation">Deprecated';if("see"in a)f+=" - see "+(typeof a.see=="string"?a.see:a.see.join(", "));f+="</div>"}a.elmt=$('<a class="'+c+'" href="javascript:{}"><span class="codeAssist-entry-title">'+d+"</span>"+f+("hint"in a?' <span class="cuecard-suggestion-hint">'+a.hint+"</span>":"")+"</a>")};
CodeAssist.ScopedSuggestor=function(a,e,b){this._suggestions=a;this._onCommit=e;this.onKeyDown=b;for(a=0;a<this._suggestions.length;a++)CodeAssist.renderApiSuggestion(this._suggestions[a],"")};CodeAssist.ScopedSuggestor.prototype.getSuggestions=function(a,e){for(var b=[],d=0;d<this._suggestions.length;d++){var c=this._suggestions[d];if(a.length==0||c.label.indexOf(a)>=0)b.push(c)}e(b)};CodeAssist.ScopedSuggestor.prototype.commit=function(a){this._onCommit(a)};
CodeAssist.SearchSuggestor=function(a,e,b){this._localVariables=a;this._onCommit=e;this.onKeyDown=b;for(e=0;e<a.length;e++)CodeAssist.renderApiSuggestion(a[e],"")};
CodeAssist.SearchSuggestor.prototype.getSuggestions=function(a,e){for(var b=CodeAssist.helperUrl+(a.length==0?"assist?segments=":"search?q="+encodeURIComponent(a)),d=[],c=0;c<this._localVariables.length;c++){var f=this._localVariables[c];if(a.length==0||f.label.toLowerCase().indexOf(a)>=0)d.push(f)}CueCard.JsonpQueue.call(b,function(g){for(var h=0;h<g.length;h++){var m=g[h];CodeAssist.renderApiSuggestion(m,a);d.push(m)}e(d)},function(){e(d)})};CodeAssist.SearchSuggestor.prototype.commit=function(a){this._onCommit(a)};
CodeAssist.QueryTokenizer=function(a,e,b){this._text=a+" ";this._maxIndex=b;this._index=e;this._col=this._line=0;this.next()};CodeAssist.QueryTokenizer.prototype.token=function(){return this._token};CodeAssist.QueryTokenizer.prototype.index=function(){return this._index};CodeAssist.QueryTokenizer._whitespaces=" \t\r\n";
CodeAssist.QueryTokenizer.prototype.next=function(){this._token=null;if(this._index<this._maxIndex){var a=this._text.charAt(this._index),e=this._text.charAt(this._index+1),b=this,d=function(){b._index++;b._col++},c=function(){return new CodeAssist.TokenPos(b._index,b._line,b._col)},f=function(){var i=c();d();return i},g=function(i,k,l){var n=c();b._pos=n;b._token=new CodeAssist.Token(i,l||b._text.substring(k.offset,n.offset),k,n)},h=function(){for(var i=c();b._index<b._maxIndex;){var k=b._text.charAt(b._index);
if(CodeAssist.QueryTokenizer._whitespaces.indexOf(k)<0)break;if(k=="\n"){b._line++;b._col=0}else b._col++;b._index++}g(CodeAssist.Token.Types.whitespace,i)},m=function(i){var k=c();d();for(var l="",n=false;b._index<b._maxIndex;){a=b._text.charAt(b._index);if(a==i){d();n=true;break}else if(a=="\r"||a=="\n")break;if(a=="\\"){d();l+=b._text.charAt(b._index)}else l+=a;d()}g(CodeAssist.Token.Types[n?"stringLiteral":"error"],k,l)},p=function(){var i=c();if(a=="+")d();else a=="-"&&d();for(;b._index<b._maxIndex&&
CodeAssist.QueryTokenizer._isDigit(b._text.charAt(b._index));)d();if(b._index<b._maxIndex&&b._text.charAt(b._index)==".")for(d();b._index<b._maxIndex&&CodeAssist.QueryTokenizer._isDigit(b._text.charAt(b._index));)d();g(CodeAssist.Token.Types.numberLiteral,i)},o={"function":true,"return":true,"if":true,"else":true,"for":true,"while":true,"do":true,"break":true,"break":true,"switch":true,"case":true,"default":true,"with":true,"try":true,"catch":true,"finally":true,"throw":true,"instanceof":true,"typeof":true,
"in":true},r=function(){for(var i=c();b._index<b._maxIndex;){var k=b._text.charAt(b._index);if(CodeAssist.QueryTokenizer._identifierCharacters.indexOf(k)>=0||CodeAssist.QueryTokenizer._identifierPrefix.indexOf(k)>=0)d();else break}k=c();var l=b._text.substring(i.offset,k.offset);b._pos=k;b._token=l in o?new CodeAssist.Token(CodeAssist.Token.Types.keyword,l,i,k):new CodeAssist.Token(CodeAssist.Token.Types.identifier,l,i,k)},s=function(){var i=c();d();for(d();b._index<b._maxIndex&&b._text.charAt(b._index)!=
"\n";)d();var k=c(),l=b._text.substring(i.offset,k.offset);b._pos=k;b._token=new CodeAssist.Token(CodeAssist.Token.Types.endOfLineComment,l,i,k)},t=function(){var i=c();d();d();for(var k=false;b._index<b._maxIndex;){a=b._text.charAt(b._index);e=b._text.charAt(b._index+1);if(a=="*"&&e=="/"){d();d();k=true;break}else d()}var l=c(),n=b._text.substring(i.offset,l.offset);b._pos=l;b._token=new CodeAssist.Token(CodeAssist.Token.Types[k?"comment":"error"],n,i,l)},j=function(){var i=c();d();for(var k=false;b._index<
b._maxIndex;){a=b._text.charAt(b._index);d();if(a=="/"){k=true;break}else a=="\\"&&b._index<b._maxIndex&&d()}b._index<b._maxIndex&&"gi".indexOf(b._text.charAt(b._index))>=0&&d();var l=c(),n=b._text.substring(i.offset,l.offset);b._pos=l;b._token=new CodeAssist.Token(CodeAssist.Token.Types[k?"regexLiteral":"error"],n,i,l)};if(CodeAssist.QueryTokenizer._whitespaces.indexOf(a)>=0)h();else if(a=="/")if(e=="/")s();else if(e=="*")t();else CodeAssist.QueryTokenizer._whitespaces.indexOf(e)>=0?g(CodeAssist.Token.Types.operator,
f()):j();else if("[{()}],:;".indexOf(a)>=0)g(CodeAssist.Token.Types.delimiter,f());else if(a=='"'||a=="'")m(a);else if(a=="-"||a=="+"||CodeAssist.QueryTokenizer._isDigit(a))p();else if("<>=!+-*/?&.".indexOf(a)>=0)g(CodeAssist.Token.Types.operator,f());else CodeAssist.QueryTokenizer._identifierPrefix.indexOf(a)>=0?r():g(CodeAssist.Token.Types.error,f())}return this._token};CodeAssist.QueryTokenizer._isDigit=function(a){return"0123456789".indexOf(a)>=0};CodeAssist.QueryTokenizer._identifierPrefix="_abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ$";
CodeAssist.QueryTokenizer._identifierCharacters="0123456789";CodeAssist.TokenPos=function(a,e,b){this.offset=a;this.line=e;this.col=b};CodeAssist.Token=function(a,e,b,d){this.type=a;this.content=e;this.start=b;this.end=d};CodeAssist.Token.Types={error:-1,whitespace:0,operator:1,delimiter:2,numberLiteral:3,stringLiteral:4,booleanLiteral:5,regexLiteral:6,keyword:7,identifier:8,comment:9,endOfLineComment:10};
